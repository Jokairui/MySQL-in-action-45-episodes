## 4 深入浅出索引（上）

### Cue

常用的索引数据结构有哪些？

MySQL为什么选择B+树？

什么是页分裂和页合并？

为什么推荐表通常都应该使用自增主键？

### Notes

#### 常用的索引模型

对于一个数据库的索引的分析，只需要专注于它索引的数据模型即可

* 哈希表 ：无法加速范围查询
* 有序数组 ：搜索效率惊人，插入效率吓人
* 二叉树 ：树高意味着访问磁盘的次数更多
* N叉树 ：没有解决范围查询的问题，数据不是存在叶子结点上，叶子结点没有通过链表连接
* 跳表 ： 非常接近正确答案，稍加改造也能适合做索引，主要考虑两个方面改造，一个是底层链表改成双向链表以支持范围查询，一个是考虑磁盘存储不同层级索引的方案
* B树 : 虽然解决了树高的问题，没有实现范围查询，叶子结点没有用链表串联起来，且结点存储的是数据不是索引。B 树只是一个每个节点的子节点个数不能小于 m/2 的 m 叉树。

#### INNODB的索引模型

在INNODB中，表都是根据主键顺序以索引的形式存放的，这种存储方式称为索引组织表

INNODB使用的是B+数的索引模型，B+树的特点如下：（m一般取决于磁盘页的大小）

1. 每个节点的子节点数不能超过m，也不能小于m/2
2. 根节点的子节点个数可以小于m/2，这是一个特例
3. 除叶子节点外，其它节点只存储索引
4. 通过双向链表将叶子节点连在一起，方便范围查询
5. 一般情况下，根节点存放在内存中

##### 索引的分类

根据索引树叶子结点存储的内容的差异，索引分为**主键索引/聚簇索引**（clustered index）和**普通索引/二级索引**（secondary index）

前者的叶子结点key为ID，value为整行的内容

后者的叶子结点key为索引列的值，value为主键的值

##### 回表

先从二级索引获取ID值，再到主键索引查出具体行的内容的这个过程，称为回表



#### 索引的维护

主要是维护B+树

##### 页分裂

当一个结点已经存满，在非尾部的位置添加一个新值，则数据页分裂成两个使用率约50%的新数据页

##### 页合并

当删除一个值时，两个使用率较低的数据页合并成一个数据页



**页分裂和合并都会对性能产生影响，所以自增主键的好处就是，所有的索引新增都是追加操作，不会产生页分裂而影响性能**

**其次，自增主键一般情况下占用空间更小，可以使得其它的索引叶子结点占用的空间更少**



### Summary

了解了所以常用与作索引的数据结构，揭开MySQL选择B+树的原因。

了解了聚簇索引与非聚簇索引的区别，以及为什么会有回表。

索引插入时需要维护树高，对应就会产生页分裂和页合并这两种现象。









