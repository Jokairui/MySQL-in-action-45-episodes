### Cue

内存临时表和磁盘临时表

不同的排序算法什么时候启用？

比较好的随机算法应该是怎样的？

### Notes

#### select word from words order by rand() limit 3这条语句的排序过程

1. 全表扫描，创建一个包含rand值和word值的临时表（内存临时表）
2. 由于临时表采用memory引擎，回表没有随机磁盘访问，所以优先使用row id排序
3. 根据rand值进行排序，此处又时一次临时表的全表扫描，取得rand值最小的3列的位置信息（**有主键就是主键，没主键就是MySQL默认的row id列**）
4. 根据位置信息回表，取到word值

#### 内存临时表 & 磁盘临时表

tmp_table_size这个值默认16M，超过了16M就采用磁盘临时表进行排序

那么就会走InnoDB表的排序方式，即上一讲的内容，通过全字段排序，不得已情况下走row id排序

#### 快排 & 优先队列（堆排）& filesort（归并）

在sort_buffer中的排序默认使用快排

如果sort_buffer不够，会使用文件来辅助，通过归并排序来排序

如果limit值比较小，为了不使用磁盘来进行排序，会使用堆排序

#### 正确的随机算法

1、取最大id和最小id，计算random值，再取小于random值的limit 1，缺点是表空洞较多时，随机性不好

2、取count(*), 计算random值，再limit random，1,缺点是random得到的值较大时，相当于全表扫了多次

对于第一种方法，可以通过上线本功能前重建表的方法解决。

对于第二种方法，随机取多个单词时，可以通过拿到第一个单词对应id之后，后面的单词以>id为条件，减少扫描行数

**还有一种业务上的好方法，不用MySQL，存放在内存中**

### Summary

学习了创建临时表场景下，MySQL排序的优化机制。以及MySQL自身对不同排序算法的选择。了解了正确的随机方法。